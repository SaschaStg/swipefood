default:
  image: "node:18-alpine"

workflow:
  # set rules for when to create a pipeline
  rules:
    # only run on default branch
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # only run on merge requests
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

.build_template:
  stage: "build"
  variables:
    TARGET: "build"
  script:
    - "cd $CONTEXT"
    - "npm ci --cache .npm --prefer-offline"
    - "npm run $TARGET"

.lint_template:
  stage: "test"
  needs: [ ]
  script:
    - "cd $CONTEXT"
    - "npm ci --cache .npm --prefer-offline"
    - "npm run lint"

.docker_template:
  image: jdrouet/docker-with-buildx:stable
  tags:
    - docker-in-docker
  stage: "deploy"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  services:
    - "docker:dind"
  variables:
    PLATFORMS: linux/amd64
    DOCKERFILE: "Dockerfile"
  script:
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD registry.mi.kienhoefr.de
    - docker context create cxt
    - docker buildx create --driver docker-container --use cxt
    - docker buildx build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from=type=registry,ref=$IMAGE_REPO:$TAG --pull --platform $PLATFORMS -t $IMAGE_REPO:$TAG -t $IMAGE_REPO:$CI_COMMIT_SHA --push -f $CONTEXT\$DOCKERFILE $CONTEXT

.deploy_template:
  image: registry.gitlab.com/ci-images/alpine-deploy
  stage: "deploy"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    DEPLOY_HOST: "bwc01.host.kienhoefr.de"
    DEPLOY_USER: "deploy"
  before_script:
    # setup ssh-agent
    - eval $(ssh-agent -s)
    - chmod 600 "$SSH_KEY"
    - ssh-add "$SSH_KEY"
  script:
    - printf "$COMMANDS" | ssh -o "BatchMode=yes" -o "UserKnownHostsFile=$HOST_KEY" $DEPLOY_USER@$DEPLOY_HOST

build:frontend:
  extends: .build_template
  variables:
    CONTEXT: frontend
  artifacts:
    paths:
      - "frontend/dist"
  cache:
    key:
      files:
        - "frontend/package-lock.json"
      prefix: "frontend"
    paths:
      - "frontend/.npm"

build:backend:
  extends: .build_template
  variables:
    CONTEXT: backend
  artifacts:
    paths:
      - "backend/dist"
  cache:
    key:
      files:
        - "backend/package-lock.json"
      prefix: "backend"
    paths:
      - "backend/.npm"

build:migrations:
  extends: .build_template
  variables:
    CONTEXT: "backend"
    TARGET: "build:migrations"
  artifacts:
    paths:
      - "backend/dist-migrations"
  cache:
    key:
      files:
        - "backend/package-lock.json"
      prefix: "backend"
    paths:
      - "backend/.npm"

lint:frontend:
  extends: .lint_template
  variables:
    CONTEXT: frontend
  cache:
    key:
      files:
        - "frontend/package-lock.json"
      prefix: "frontend"
    paths:
      - "frontend/.npm"

lint:backend:
  extends: .lint_template
  variables:
    CONTEXT: backend
  cache:
    key:
      files:
        - "backend/package-lock.json"
      prefix: "backend"
    paths:
      - "backend/.npm"

deploy:staging:frontend:docker:
  extends: .docker_template
  needs:
    - "build:frontend"
    - "lint:frontend"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/frontend
    TAG: staging
    CONTEXT: frontend

deploy:staging:frontend:
  extends: .deploy_template
  needs:
    - "deploy:staging:frontend:docker"
  variables:
    COMMANDS: |
      frontend
      exit
    SSH_KEY: $STAGING_SSH_KEY
    HOST_KEY: $BWC01_HOST_KEY
  environment:
    name: "staging"
    url: "https://swipefood-staging.mi.kienhoefr.de"

deploy:staging:backend:docker:
  extends: .docker_template
  needs:
    - "build:backend"
    - "lint:backend"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/backend
    TAG: staging
    CONTEXT: backend

deploy:staging:migrations:docker:
  extends: .docker_template
  needs:
    - "build:migrations"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/migrations
    TAG: staging
    CONTEXT: backend
    DOCKERFILE: "migrations.dockerfile"

# This will also run migrations
deploy:staging:backend:
  extends: .deploy_template
  needs:
    - "deploy:staging:backend:docker"
  variables:
    COMMANDS: |
      backend
      exit
    SSH_KEY: $STAGING_SSH_KEY
    HOST_KEY: $BWC01_HOST_KEY
  environment:
    name: "staging API"
    url: "https://swipefood-staging.mi.kienhoefr.de/api"

deploy:prod:frontend:docker:
  extends: .docker_template
  when: "manual"
  needs:
    - "deploy:staging:frontend"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/frontend
    TAG: latest
    CONTEXT: frontend

deploy:prod:frontend:
  extends: .deploy_template
  when: "manual"
  needs:
    - "deploy:prod:frontend:docker"
  variables:
    COMMANDS: |
      frontend
      exit
    SSH_KEY: $PROD_SSH_KEY
    HOST_KEY: $BWC01_HOST_KEY
  environment:
    name: "production"
    url: "https://swipefood.mi.kienhoefr.de"

deploy:prod:backend:docker:
  extends: .docker_template
  when: "manual"
  needs:
    - "deploy:staging:backend"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/backend
    TAG: latest
    CONTEXT: backend

deploy:prod:migrations:docker:
  extends: .docker_template
  needs:
    - "deploy:staging:backend"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/migrations
    TAG: latest
    CONTEXT: backend
    DOCKERFILE: "migrations.dockerfile"

# This will also run migrations
deploy:prod:backend:
  extends: .deploy_template
  when: "manual"
  needs:
    - "deploy:prod:backend:docker"
  variables:
    COMMANDS: |
      backend
      exit
    SSH_KEY: $PROD_SSH_KEY
    HOST_KEY: $BWC01_HOST_KEY
  environment:
    name: "production API"
    url: "https://swipefood.mi.kienhoefr.de/api"
