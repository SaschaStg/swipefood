default:
  image: "node:18-alpine"

workflow:
  # set rules for when to create a pipeline
  rules:
    # only run on default branch
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # only run on merge requests
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:frontend:
  stage: "build"
  script:
    - "cd frontend"
    - "npm ci --cache .npm --prefer-offline"
    - "npm run build"
  artifacts:
    paths:
      - "frontend/dist"
  cache:
    key:
      files:
        - "frontend/package-lock.json"
      prefix: "frontend"
    paths:
      - "frontend/.npm"

build:backend:
  stage: "build"
  script:
    - "cd backend"
    - "npm ci --cache .npm --prefer-offline"
    - "npm run build"
  artifacts:
    paths:
      - "backend/dist"
  cache:
    key:
      files:
        - "backend/package-lock.json"
      prefix: "backend"

lint:frontend:
  stage: "test"
  needs: []
  script:
    - "cd frontend"
    - "npm ci --cache .npm --prefer-offline"
    - "npm run lint"
  cache:
    key:
      files:
        - "backend/package-lock.json"
      prefix: "backend"

lint:backend:
  stage: "test"
  needs: []
  script:
    - "cd backend"
    - "npm ci --cache .npm --prefer-offline"
    - "npm run lint"
  cache:
    key:
      files:
        - "backend/package-lock.json"
      prefix: "backend"

deploy:staging:frontend:docker:
  image: jdrouet/docker-with-buildx:stable
  tags:
    - docker-in-docker
  stage: "deploy"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - "build:frontend"
    - "lint:frontend"
  services:
    - "docker:dind"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/frontend
    TAG: staging
    PLATFORMS: linux/amd64
  script:
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD registry.mi.kienhoefr.de
    - docker context create cxt
    - docker buildx create --driver docker-container --use cxt
    - docker buildx build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from=type=registry,ref=$IMAGE_REPO:$TAG --pull --platform $PLATFORMS -t $IMAGE_REPO:$TAG -t $IMAGE_REPO:$CI_COMMIT_SHA --push frontend

deploy:prod:frontend:docker:
  image: jdrouet/docker-with-buildx:stable
  tags:
    - docker-in-docker
  stage: "deploy"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: "manual"
  needs:
    - "build:frontend"
    - "lint:frontend"
    - "deploy:staging:frontend"
  services:
    - "docker:dind"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/frontend
    TAG: latest
    PLATFORMS: linux/amd64
  script:
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD registry.mi.kienhoefr.de
    - docker context create cxt
    - docker buildx create --driver docker-container --use cxt
    - docker buildx build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from=type=registry,ref=$IMAGE_REPO:$CI_COMMIT_SHA --pull --platform $PLATFORMS -t $IMAGE_REPO:$TAG -t $IMAGE_REPO:$CI_COMMIT_SHA --push frontend

deploy:staging:backend:docker:
  image: jdrouet/docker-with-buildx:stable
  tags:
    - docker-in-docker
  stage: "deploy"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - "build:backend"
    - "lint:backend"
  services:
    - "docker:dind"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/backend
    TAG: staging
    PLATFORMS: linux/amd64
  script:
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD registry.mi.kienhoefr.de
    - docker context create cxt
    - docker buildx create --driver docker-container --use cxt
    - docker buildx build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from=type=registry,ref=$IMAGE_REPO:$TAG --pull --platform $PLATFORMS -t $IMAGE_REPO:$TAG -t $IMAGE_REPO:$CI_COMMIT_SHA --push backend

deploy:prod:backend:docker:
  image: jdrouet/docker-with-buildx:stable
  tags:
    - docker-in-docker
  stage: "deploy"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: "manual"
  needs:
    - "build:backend"
    - "lint:backend"
    - "deploy:staging:backend"
  services:
    - "docker:dind"
  variables:
    IMAGE_REPO: registry.mi.kienhoefr.de/swipefood/backend
    TAG: latest
    PLATFORMS: linux/amd64
  script:
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD registry.mi.kienhoefr.de
    - docker context create cxt
    - docker buildx create --driver docker-container --use cxt
    - docker buildx build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from=type=registry,ref=$IMAGE_REPO:$CI_COMMIT_SHA --pull --platform $PLATFORMS -t $IMAGE_REPO:$TAG -t $IMAGE_REPO:$CI_COMMIT_SHA --push backend
